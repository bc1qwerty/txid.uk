{{ define "main" }}
<article class="max-w-3xl mx-auto px-4 sm:px-6 py-12">
  <!-- Learning path detection (from txid.uk single.html) -->
  {{- $currentURL := .RelPermalink -}}
  {{- $pathFound := false -}}
  {{- $pathTitle := "" -}}
  {{- $pathURL := "" -}}
  {{- $stepNum := 0 -}}
  {{- $totalSteps := 0 -}}
  {{- $prevStep := dict -}}
  {{- $nextStep := dict -}}
  {{- range where site.RegularPages "Section" "learn" -}}
    {{- $path := . -}}
    {{- range $i, $step := .Params.steps -}}
      {{- if eq $step.url $currentURL -}}
        {{- $pathFound = true -}}
        {{- $pathTitle = $path.Title -}}
        {{- $pathURL = $path.RelPermalink -}}
        {{- $stepNum = add $i 1 -}}
        {{- $totalSteps = len $path.Params.steps -}}
        {{- if gt $i 0 -}}
          {{- $prevStep = index $path.Params.steps (sub $i 1) -}}
        {{- end -}}
        {{- if lt (add $i 1) $totalSteps -}}
          {{- $nextStep = index $path.Params.steps (add $i 1) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  <!-- Learning path indicator -->
  {{ if $pathFound }}
  <div class="mb-6 p-3 rounded-lg bg-bitcoin/5 border border-bitcoin/20">
    <div class="flex items-center justify-between flex-wrap gap-2">
      <a href="{{ $pathURL }}" class="text-sm text-bitcoin hover:underline font-medium">← {{ $pathTitle }}</a>
      <div class="flex items-center gap-1.5">
        {{ range $i, $_ := seq $totalSteps }}
        <div class="w-2 h-2 rounded-full {{ if eq (add $i 1) $stepNum }}bg-bitcoin{{ else if lt (add $i 1) $stepNum }}bg-bitcoin/40{{ else }}bg-gray-700{{ end }}"></div>
        {{ end }}
        <span class="text-xs text-gray-500 ml-1.5">{{ $stepNum }}/{{ $totalSteps }}</span>
      </div>
    </div>
  </div>
  {{ end }}

  <!-- Breadcrumb (non-path pages) -->
  {{ if not $pathFound }}
  <nav class="mb-6 text-sm text-gray-600" aria-label="breadcrumb">
    <a href="/" class="hover:text-gray-400 transition-colors">홈</a>
    <span class="mx-1.5">/</span>
    <a href="/ideas/" class="hover:text-gray-400 transition-colors">개념</a>
    <span class="mx-1.5">/</span>
    <span class="text-gray-500">{{ .Title }}</span>
  </nav>
  {{ end }}

  <header class="mb-10">
    <div class="flex items-center gap-2 mb-4">
      {{ range .Params.tags }}
      <span class="text-xs px-2 py-0.5 rounded-full bg-gray-800 text-gray-400">{{ . }}</span>
      {{ end }}
      {{ with .Params.levels }}
      <span class="text-xs px-2 py-0.5 rounded-full bg-bitcoin/10 text-bitcoin">{{ . }}</span>
      {{ end }}
    </div>
    <h1 class="text-3xl sm:text-4xl font-bold text-white leading-tight">{{ .Title }}</h1>
    {{ with .Description }}
    <p class="mt-3 text-lg text-gray-400">{{ . }}</p>
    {{ end }}
    <div class="flex items-center gap-3 mt-4 text-sm text-gray-600">
      <span>{{ math.Round (div (countwords .Content) 200.0) }}분 소요</span>
    </div>
  </header>

  <div class="article-prose">
    {{ .Content }}
  </div>

  <!-- Related concepts -->
  {{ if .Params.tags }}
  {{ $currentPage := . }}
  {{ $related := slice }}
  {{ range .Params.tags }}
    {{ $tag := . }}
    {{ with index site.Taxonomies.tags $tag }}
    {{ range .Pages }}
      {{ if ne .RelPermalink $currentPage.RelPermalink }}
        {{ $related = $related | append . }}
      {{ end }}
    {{ end }}
    {{ end }}
  {{ end }}
  {{ $related = $related | uniq }}
  {{ if $related }}
  <section class="mt-12 pt-8 border-t border-gray-800/50">
    <h3 class="text-lg font-semibold text-white mb-4">관련 개념</h3>
    <div class="grid gap-2">
      {{ range first 5 $related }}
      <a href="{{ .RelPermalink }}" class="flex items-center justify-between p-3 rounded-lg border border-gray-800/50 hover:border-bitcoin/30 hover:bg-gray-900/60 transition-all group">
        <span class="text-gray-300 group-hover:text-white transition-colors">{{ .Title }}</span>
        <span class="text-gray-600 group-hover:text-bitcoin transition-colors">&rarr;</span>
      </a>
      {{ end }}
    </div>
  </section>
  {{ end }}
  {{ end }}

  <!-- Navigation -->
  {{ if $pathFound }}
  <nav class="mt-16 pt-8 border-t border-bitcoin/20 flex justify-between gap-4">
    {{ if $prevStep.url }}
    <a href="{{ $prevStep.url }}" class="group flex-1 p-5 rounded-xl border border-gray-700/50 bg-gray-900/60 hover:border-gray-600 transition-all">
      <span class="flex items-center gap-1.5 text-sm text-gray-400 mb-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        {{ sub $stepNum 1 }}단계
      </span>
      <span class="text-base text-gray-300 font-medium group-hover:text-white transition-colors">{{ $prevStep.title }}</span>
    </a>
    {{ else }}<div class="flex-1"></div>{{ end }}
    {{ if $nextStep.url }}
    <a href="{{ $nextStep.url }}" class="group flex-1 p-5 rounded-xl border border-bitcoin/30 bg-bitcoin/10 hover:bg-bitcoin/20 transition-all text-right">
      <span class="flex items-center justify-end gap-1.5 text-sm text-bitcoin mb-2">
        {{ add $stepNum 1 }}단계
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </span>
      <span class="text-base text-white font-semibold group-hover:text-bitcoin-light transition-colors">{{ $nextStep.title }}</span>
    </a>
    {{ else }}
    <a href="{{ $pathURL }}" class="group flex-1 p-5 rounded-xl border border-bitcoin/40 bg-bitcoin/15 hover:bg-bitcoin/25 transition-all text-right">
      <span class="flex items-center justify-end gap-1.5 text-sm text-bitcoin mb-2">✓ 코스 완료</span>
      <span class="text-base text-white font-semibold group-hover:text-bitcoin-light transition-colors">{{ $pathTitle }}로 돌아가기</span>
    </a>
    {{ end }}
  </nav>
  {{ else }}
  <nav class="mt-16 pt-8 border-t border-gray-800/50 flex justify-between gap-4">
    {{ with .NextInSection }}
    <a href="{{ .Permalink }}" class="group flex-1 p-5 rounded-xl border border-gray-700/50 bg-gray-900/60 hover:border-gray-600 transition-all">
      <span class="text-sm text-gray-400 mb-1 block">&larr; 이전</span>
      <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{ .Title }}</span>
    </a>
    {{ else }}<div class="flex-1"></div>{{ end }}
    {{ with .PrevInSection }}
    <a href="{{ .Permalink }}" class="group flex-1 p-5 rounded-xl border border-gray-700/50 bg-gray-900/60 hover:border-gray-600 transition-all text-right">
      <span class="text-sm text-gray-400 mb-1 block">다음 &rarr;</span>
      <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{ .Title }}</span>
    </a>
    {{ else }}<div class="flex-1"></div>{{ end }}
  </nav>
  {{ end }}
</article>
{{ end }}
